name: Dependabot Auto-merge (safe)

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: dependabot-automerge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  automerge:
    name: Enable auto-merge (squash) for safe updates
    if: github.actor == 'dependabot[bot]' && github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Dependabot metadata
        id: meta
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge when eligible
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const prNodeId = context.payload.pull_request.node_id;

            const updateType = `${{ steps.meta.outputs.update-type }}`; // ex: version-update:semver-patch / semver-minor / semver-major
            const isSecurityUpdate = `${{ steps.meta.outputs.security-update }}` === 'true';

            const isSafeSemver =
              updateType === 'version-update:semver-patch' ||
              updateType === 'version-update:semver-minor';

            if (!isSecurityUpdate && !isSafeSemver) {
              core.info(`Not enabling auto-merge. update-type=${updateType} security=${isSecurityUpdate}`);
              return;
            }

            // Evita tentar enquanto o GitHub ainda está calculando mergeability (unknown/unstable)
            const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
            const maxAttempts = 12;
            const waitMs = 5000;

            let mergeableState = 'unknown';
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });

              if (pr.draft || pr.state !== 'open') {
                core.info(`PR #${prNumber} not eligible (state=${pr.state}, draft=${pr.draft}).`);
                return;
              }

              mergeableState = pr.mergeable_state; // clean/blocked/dirty/unknown/unstable
              core.info(`PR #${prNumber} attempt ${attempt}/${maxAttempts}: mergeable_state=${mergeableState}`);

              if (mergeableState !== 'unknown' && mergeableState !== 'unstable') break;
              await sleep(waitMs);
            }

            if (mergeableState === 'dirty') {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `❌ Auto-merge não habilitado: PR está com conflitos (mergeable_state=dirty).`
              }).catch(() => {});
              return;
            }

            // Habilita auto-merge (SQUASH). O GitHub só vai efetivar quando os checks obrigatórios passarem.
            try {
              await github.graphql(
                `
                mutation($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(
                    input: { pullRequestId: $pullRequestId, mergeMethod: SQUASH }
                  ) {
                    pullRequest { number }
                  }
                }
                `,
                { pullRequestId: prNodeId }
              );

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `✅ Auto-merge (squash) habilitado para este PR do Dependabot.\n- security-update: **${isSecurityUpdate}**\n- update-type: **${updateType}**\nO merge vai acontecer automaticamente quando todos os checks obrigatórios ficarem verdes.`
              }).catch(() => {});
            } catch (e) {
              const msg = String(e?.message || e);
              core.warning(`Failed to enable auto-merge: ${msg}`);

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `❌ Não consegui habilitar auto-merge via API.\nErro: \`${msg}\`\nVerifique se **Allow auto-merge** está ligado nas configurações do repo e se os permissions do workflow estão como **Read and write**.`
              }).catch(() => {});
              throw e;
            }
