name: Manus Autopilot (checks)

on:
  workflow_run:
    workflows: ["CI", "CodeQL"]
    types: [completed]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  autopilot:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Manus on failure / clear busy on success (with SHA fallback)
        uses: actions/github-script@v7
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_PROJECT_ID: ${{ secrets.MANUS_PROJECT_ID }}
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Seguran√ßa: s√≥ age em runs disparados por PR
            // (evita agir em pushes diretos, schedule etc.)
            if (run.event !== "pull_request") {
              core.info(`Ignorando workflow_run (event=${run.event}).`);
              return;
            }

            // Helper: busca PRs associados ao workflow_run
            async function getAssociatedPRNumbers() {
              // 1) tentativa padr√£o pelo payload
              const prs = run.pull_requests || [];
              if (prs.length > 0) return prs.map(p => p.number);

              // 2) fallback por SHA (o seu caso)
              const sha = run.head_sha;
              if (!sha) return [];

              try {
                const { data } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner,
                  repo,
                  commit_sha: sha,
                  mediaType: { previews: ["groot"] }
                });

                return (data || []).map(pr => pr.number);
              } catch (e) {
                core.warning(`Falha ao buscar PR por SHA (${sha}): ${String(e?.message || e)}`);
                return [];
              }
            }

            const prNumbers = await getAssociatedPRNumbers();

            if (prNumbers.length === 0) {
              core.info("Nenhum PR associado a este workflow_run (nem por SHA).");
              return;
            }

            const busyLabel = "manus-busy";
            const isSuccess = run.conclusion === "success";
            const isFailureLike = ["failure", "cancelled", "timed_out", "action_required"].includes(run.conclusion);

            // Se n√£o √© sucesso nem falha, n√£o faz nada (ex: skipped/neutral)
            if (!isSuccess && !isFailureLike) {
              core.info(`Conclus√£o ${run.conclusion} n√£o aciona autopilot.`);
              return;
            }

            for (const prNumber of prNumbers) {
              // Carrega PR completo
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });

              const headRef = pr.data.head.ref || "";
              const state = pr.data.state;
              const draft = pr.data.draft;

              // S√≥ PRs manus/*
              if (!headRef.startsWith("manus/")) {
                core.info(`PR #${prNumber} n√£o √© manus/* (${headRef}). Ignorando.`);
                continue;
              }

              if (state !== "open") {
                core.info(`PR #${prNumber} n√£o est√° open (state=${state}). Ignorando.`);
                continue;
              }

              if (draft) {
                core.info(`PR #${prNumber} est√° draft. Ignorando.`);
                continue;
              }

              const labels = (pr.data.labels || []).map(l => l.name);

              // ‚úÖ Se os checks ficaram verdes -> remove busy e comenta
              if (isSuccess) {
                if (labels.includes(busyLabel)) {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number: prNumber,
                    name: busyLabel
                  }).catch(() => {});

                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: prNumber,
                    body: `‚úÖ Checks passaram (${run.name}). Label **${busyLabel}** removida. Autopilot liberado.\nRun: ${run.html_url}`
                  }).catch(() => {});
                } else {
                  core.info(`PR #${prNumber}: checks success, mas n√£o estava busy.`);
                }
                continue;
              }

              // ‚ùå Se falhou -> aciona Manus (mas s√≥ se n√£o estiver busy)
              if (labels.includes(busyLabel)) {
                core.info(`PR #${prNumber} j√° est√° busy (${busyLabel}). N√£o acionando outra task.`);
                continue;
              }

              // Marca busy
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: [busyLabel]
              });

              // Monta prompt para Manus
              const prompt = `
              Voc√™ √© o agente Manus respons√°vel por corrigir falhas de CI/CodeQL neste reposit√≥rio.
              
              Reposit√≥rio: ${owner}/${repo}
              Pull Request: ${pr.data.html_url}
              Branch do PR: ${headRef}
              
              Falha detectada:
              - Workflow: ${run.name}
              - Conclus√£o: ${run.conclusion}
              - Run: ${run.html_url}
              - SHA: ${run.head_sha}
              
              Objetivo:
              1) Abrir o link do Run e identificar o PRIMEIRO step que falhou (mensagem de erro + arquivo/linha se houver).
              2) Corrigir com o MENOR patch poss√≠vel (n√£o refatorar sem necessidade).
              3) Fazer push de commits na MESMA branch do PR: ${headRef}
              4) N√ÉO fazer merge.
              5) Repetir at√© ficar tudo verde (CI + CodeQL).
              
              Regras:
              - Se o erro for de depend√™ncia/ambiente (ex.: missing env var / servi√ßo externo), N√ÉO invente.
                Comente no PR qual vari√°vel/servi√ßo falta e pare.
              - Se houver testes quebrando por depender de DB/servi√ßo, ajuste para mock/local ou desabilite o teste problem√°tico com justificativa no PR.
              
              Ao finalizar, comentar no PR:
              - causa raiz (1‚Äì2 linhas)
              - arquivos alterados
              - como validar (comandos)
              `.trim();

              const body = {
                prompt,
                agentProfile: "manus-1.6",
                taskMode: "agent",
                interactiveMode: false
              };

              if (process.env.MANUS_PROJECT_ID) body.projectId = process.env.MANUS_PROJECT_ID;

              // Chama Manus
              const res = await fetch("https://api.manus.ai/v1/tasks", {
                method: "POST",
                headers: {
                  "API_KEY": process.env.MANUS_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
              });

              if (!res.ok) {
                const text = await res.text();
                throw new Error(`Manus API error: ${res.status} ${text}`);
              }

              const data = await res.json();

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `ü§ñ **Manus Autopilot acionado**: **${run.name}** falhou.\n- Task: ${data.task_url}\n- Run: ${run.html_url}\n\n(Prote√ß√£o ativa: label **${busyLabel}** adicionada para evitar tasks duplicadas.)`
              });
