name: Manus Autopilot (checks)

on:
  workflow_run:
    workflows: ["CI", "CodeQL"]
    types: [completed]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  autopilot:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Manus on failure / clear busy on success (SHA fallback)
        uses: actions/github-script@v7
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_PROJECT_ID: ${{ secrets.MANUS_PROJECT_ID }}
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // SeguranÃ§a: sÃ³ processa runs disparados por PR
            if (run.event !== "pull_request") {
              core.info(`Ignorando workflow_run (event=${run.event}).`);
              return;
            }

            // Helper: tenta achar PR pelo payload e depois por SHA
            async function getAssociatedPRNumbers() {
              const prs = run.pull_requests || [];
              if (prs.length > 0) return prs.map(p => p.number);

              const sha = run.head_sha;
              if (!sha) return [];

              try {
                const { data } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner,
                  repo,
                  commit_sha: sha,
                  mediaType: { previews: ["groot"] }
                });
                return (data || []).map(pr => pr.number);
              } catch (e) {
                core.warning(`Falha ao buscar PR por SHA (${sha}): ${String(e?.message || e)}`);
                return [];
              }
            }

            const prNumbers = await getAssociatedPRNumbers();

            if (!prNumbers || prNumbers.length === 0) {
              core.info("Nenhum PR associado a este workflow_run (nem por SHA).");
              return;
            }

            const busyLabel = "manus-busy";
            const isSuccess = run.conclusion === "success";
            const isFailureLike = ["failure", "cancelled", "timed_out", "action_required"].includes(run.conclusion);

            // NÃ£o faz nada em casos neutros/skipped
            if (!isSuccess && !isFailureLike) {
              core.info(`ConclusÃ£o ${run.conclusion} nÃ£o aciona autopilot.`);
              return;
            }

            for (const prNumber of prNumbers) {
              // Carrega PR completo
              const prResp = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
              const pr = prResp.data;

              const headRef = pr.head?.ref || "";
              const state = pr.state;
              const draft = pr.draft;

              // SÃ³ PRs manus/*
              if (!headRef.startsWith("manus/")) {
                core.info(`PR #${prNumber} nÃ£o Ã© manus/* (${headRef}). Ignorando.`);
                continue;
              }

              if (state !== "open") {
                core.info(`PR #${prNumber} nÃ£o estÃ¡ open (state=${state}). Ignorando.`);
                continue;
              }

              if (draft) {
                core.info(`PR #${prNumber} estÃ¡ draft. Ignorando.`);
                continue;
              }

              const labels = (pr.labels || []).map(l => l.name);

              // âœ… Se sucesso -> remove busy e comenta
              if (isSuccess) {
                if (labels.includes(busyLabel)) {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number: prNumber,
                    name: busyLabel
                  }).catch(() => {});

                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: prNumber,
                    body: `âœ… Checks passaram (${run.name}). Label **${busyLabel}** removida. Autopilot liberado.\nRun: ${run.html_url}`
                  }).catch(() => {});
                } else {
                  core.info(`PR #${prNumber}: checks success, mas nÃ£o estava busy.`);
                }
                continue;
              }

              // âŒ Falhou -> se jÃ¡ estÃ¡ busy, nÃ£o cria task de novo
              if (labels.includes(busyLabel)) {
                core.info(`PR #${prNumber} jÃ¡ estÃ¡ busy (${busyLabel}). NÃ£o acionando outra task.`);
                continue;
              }

              // Se secrets nÃ£o existem, comenta e sai (evita loop)
              if (!process.env.MANUS_API_KEY) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: `âš ï¸ Manus Autopilot nÃ£o pÃ´de ser acionado porque **MANUS_API_KEY** nÃ£o estÃ¡ configurada nos Secrets.`
                }).catch(() => {});
                continue;
              }

              // Marca busy antes de chamar Manus
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: [busyLabel]
              }).catch(() => {});

              // Monta prompt para Manus
              const prompt = `
            VocÃª Ã© o agente Manus responsÃ¡vel por corrigir falhas de CI/CodeQL neste repositÃ³rio.

            RepositÃ³rio: ${owner}/${repo}
            Pull Request: ${pr.html_url}
            Branch do PR: ${headRef}

            Falha detectada:
            - Workflow: ${run.name}
            - ConclusÃ£o: ${run.conclusion}
            - Run: ${run.html_url}
            - SHA: ${run.head_sha}

            Objetivo:
            1) Abrir o link do Run e identificar o PRIMEIRO step que falhou (mensagem de erro + arquivo/linha se houver).
            2) Corrigir com o MENOR patch possÃ­vel (nÃ£o refatorar sem necessidade).
            3) Fazer push de commits na MESMA branch do PR: ${headRef}
            4) NÃƒO fazer merge.
            5) Repetir atÃ© ficar tudo verde (CI + CodeQL).

            Regras:
            - Se o erro for de dependÃªncia/ambiente (ex.: missing env var / serviÃ§o externo), NÃƒO invente.
              Comente no PR qual variÃ¡vel/serviÃ§o falta e pare.

            Ao finalizar, comentar no PR:
            - causa raiz (1â€“2 linhas)
            - arquivos alterados
            - como validar (comandos)
              `.trim();

              // âœ… Payload CORRETO (camelCase) + envia o objeto CERTO no JSON.stringify
              const bodyPayload = {
                prompt,
                agentProfile: "manus-1.6",
                taskMode: "agent",
                interactiveMode: false
              };

              if (process.env.MANUS_PROJECT_ID) {
                bodyPayload.projectId = process.env.MANUS_PROJECT_ID;
              }

              try {
                const res = await fetch("https://api.manus.ai/v1/tasks", {
                  method: "POST",
                  headers: {
                    "API_KEY": process.env.MANUS_API_KEY,
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify(bodyPayload)
                });

                if (!res.ok) {
                  const text = await res.text();
                  // remove busy se falhar criar task
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number: prNumber,
                    name: busyLabel
                  }).catch(() => {});
                  throw new Error(`Manus API error: ${res.status} ${text}`);
                }

                const data = await res.json();

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: `ðŸ¤– **Manus Autopilot acionado**: **${run.name}** falhou.\n- Task: ${data.task_url || "(task_url nÃ£o retornado)"}\n- Run: ${run.html_url}\n\n(Label **${busyLabel}** adicionada para evitar tasks duplicadas.)`
                }).catch(() => {});

                core.info(`Manus task criada para PR #${prNumber}.`);

              } catch (err) {
                core.warning(`Erro ao acionar Manus para PR #${prNumber}: ${String(err?.message || err)}`);
                throw err;
              }
            }
