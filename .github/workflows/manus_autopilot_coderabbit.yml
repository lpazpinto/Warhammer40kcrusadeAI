name: Manus Autopilot (coderabbit)

on:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  autopilot:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Manus when CodeRabbit leaves feedback
        uses: actions/github-script@v7
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_PROJECT_ID: ${{ secrets.MANUS_PROJECT_ID }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let prNumber = null;
            let feedbackUrl = null;
            let author = null;
            let feedbackText = "";
            let reviewState = "";

            if (context.eventName === "pull_request_review") {
              prNumber = context.payload.pull_request.number;
              feedbackUrl = context.payload.review.html_url;
              author = context.payload.review.user?.login;
              feedbackText = (context.payload.review.body || "").trim();
              reviewState = (context.payload.review.state || "").toLowerCase();

              // Ajuste 2: nÃ£o disparar em APPROVED sem texto
              if (reviewState === "approved" && !feedbackText) {
                core.info("Approved review without text; skipping.");
                return;
              }
            } else if (context.eventName === "pull_request_review_comment") {
              prNumber = context.payload.pull_request.number;
              feedbackUrl = context.payload.comment.html_url;
              author = context.payload.comment.user?.login;
              feedbackText = (context.payload.comment.body || "").trim();
            } else if (context.eventName === "issue_comment") {
              if (!context.payload.issue.pull_request) return; // nÃ£o Ã© PR
              prNumber = context.payload.issue.number;
              feedbackUrl = context.payload.comment.html_url;
              author = context.payload.comment.user?.login;
              feedbackText = (context.payload.comment.body || "").trim();
            } else {
              return;
            }

            // Ajuste 1: se nÃ£o tem texto (e nÃ£o Ã© review), nÃ£o dispara
            if (!feedbackText && context.eventName !== "pull_request_review") {
              core.info("No feedback text found; skipping.");
              return;
            }

            // Filtro do CodeRabbit
            const login = (author || "").toLowerCase();
            const allowed = new Set(["coderabbitai", "coderabbitai[bot]"]);
            const isCodeRabbit = allowed.has(login) || login.includes("coderabbit");
            if (!isCodeRabbit) return;

            // Carrega PR
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });

            // Filtro por branch manus/*
            const headRef = pr.data.head.ref || "";
            if (!headRef.startsWith("manus/")) {
              core.info(`Not a manus branch (${headRef}). Exiting.`);
              return;
            }

            // Busy lock
            const labels = pr.data.labels.map(l => l.name);
            const busyLabel = "manus-busy";
            if (labels.includes(busyLabel)) return;

            await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: [busyLabel] });

            // Monta prompt (inclui corpo se existir)
            const promptLines = [
              "VocÃª Ã© o agente Manus trabalhando neste repositÃ³rio e hÃ¡ novo feedback do CodeRabbit.",
              "",
              `RepositÃ³rio: ${owner}/${repo}`,
              `PR: ${pr.data.html_url}`,
              `Branch: ${headRef}`,
              `Feedback link: ${feedbackUrl}`,
            ];

            if (feedbackText) {
              promptLines.push("", "ConteÃºdo do feedback (texto):", "```", feedbackText, "```");
            }

            promptLines.push(
              "",
              "Tarefa:",
              "1) Ler o feedback completo do CodeRabbit no PR (threads inclusive).",
              "2) Aplicar correÃ§Ãµes/melhorias sugeridas que fizerem sentido.",
              `3) Fazer push na MESMA branch do PR (${headRef}).`,
              "4) Garantir CI/CodeQL verdes (se quebrar, conserte).",
              "5) NÃƒO fazer merge.",
              "",
              "Ao finalizar, comentar no PR:",
              "- o que foi feito",
              "- por que foi feito",
              "- como validar."
            );

            const prompt = promptLines.join("\n");

            const body = {
              prompt,
              agentProfile: "manus-1.6",
              taskMode: "agent",
              interactiveMode: false
            };

            if (process.env.MANUS_PROJECT_ID) body.projectId = process.env.MANUS_PROJECT_ID;

            // Ajuste 3: se falhar ao criar task no Manus, remove manus-busy
            let data;
            try {
              const res = await fetch("https://api.manus.ai/v1/tasks", {
                method: "POST",
                headers: {
                  "API_KEY": process.env.MANUS_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
              });

              if (!res.ok) {
                throw new Error(`Manus API error: ${res.status} ${await res.text()}`);
              }

              data = await res.json();
            } catch (err) {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: prNumber, name: busyLabel }).catch(() => {});
              throw err;
            }

            // Ajuste 4: incluir o tipo de evento no comentÃ¡rio (debug)
            await github.rest.issues.createComment({
              owner, repo, issue_number: prNumber,
              body: `ğŸ¤– Manus Autopilot acionado por feedback do CodeRabbit (${context.eventName}).\nTask: ${data.task_url}`
            });
