name: Manus Autopilot (coderabbit - debounced 15m)

on:
  pull_request_review:
    types: [submitted, edited]
  pull_request_review_comment:
    types: [created, edited]
  issue_comment:
    types: [created, edited]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  debounce_and_trigger:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # âœ… Debounce por PR (cancela o job anterior se chegar outro evento)
    concurrency:
      group: coderabbit-debounce-${{ github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: true

    steps:
      - name: Decide if this event should start the 15m debounce timer
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let prNumber = null;
            let author = null;

            if (context.eventName === "pull_request_review") {
              prNumber = context.payload.pull_request?.number;
              author = context.payload.review?.user?.login;
            } else if (context.eventName === "pull_request_review_comment") {
              prNumber = context.payload.pull_request?.number;
              author = context.payload.comment?.user?.login;
            } else if (context.eventName === "issue_comment") {
              // SÃ³ age se for comentÃ¡rio em PR
              if (!context.payload.issue?.pull_request) {
                core.setOutput("should_run", "false");
                return;
              }
              prNumber = context.payload.issue?.number;
              author = context.payload.comment?.user?.login;
            } else {
              core.setOutput("should_run", "false");
              return;
            }

            const login = (author || "").toLowerCase();
            const isCodeRabbit =
              login === "coderabbitai" ||
              login === "coderabbitai[bot]" ||
              login.includes("coderabbit");

            if (!isCodeRabbit || !prNumber) {
              core.setOutput("should_run", "false");
              return;
            }

            // Guarda PR number pra usar depois
            core.setOutput("should_run", "true");
            core.setOutput("pr_number", String(prNumber));

      - name: Wait 15 minutes (debounce)
        if: steps.meta.outputs.should_run == 'true'
        run: sleep 900

      - name: Trigger Manus only if actionable CodeRabbit feedback exists
        if: steps.meta.outputs.should_run == 'true'
        uses: actions/github-script@v7
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_PROJECT_ID: ${{ secrets.MANUS_PROJECT_ID }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const prNumber = Number("${{ steps.meta.outputs.pr_number }}");
            const busyLabel = "manus-busy";

            function isActionable(text) {
              if (!text) return false;

              const raw = String(text).trim();
              if (raw.length < 120) return false;

              const t = raw.toLowerCase();

              // Placeholder/â€œreviewingâ€¦â€ â†’ ignora
              const placeholder = [
                /review in progress/i,
                /i['â€™]?m reviewing/i,
                /starting (my )?review/i,
                /generating review/i,
                /analyzing/i,
                /please wait/i,
                /working on it/i
              ];
              if (placeholder.some(re => re.test(raw))) return false;

              // Marcadores tÃ­picos de review final do CodeRabbit
              const strongMarkers = [
                "walkthrough",
                "pre-merge checks",
                "finishing touches",
                "recent review details",
                "nitpick",
                "suggestions",
                "issues found",
                "security",
                "performance",
                "recommended changes"
              ];

              const hasStrongMarker = strongMarkers.some(m => t.includes(m));

              // Sinais â€œactionableâ€ comuns
              const hasSignals =
                raw.includes("âœ…") ||
                raw.includes("âŒ") ||
                t.includes("suggest") ||
                t.includes("fix") ||
                t.includes("should") ||
                t.includes("change") ||
                t.includes("refactor") ||
                t.includes("warning") ||
                t.includes("error") ||
                t.includes("vulnerability") ||
                raw.includes("```");

              // Aceita se tiver marcador forte OU sinais+texto grande
              return hasStrongMarker || (hasSignals && raw.length >= 200);
            }

            // 1) Carrega PR
            const prResp = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            const pr = prResp.data;

            const headRef = pr.head?.ref || "";
            if (!headRef.startsWith("manus/")) {
              core.info(`PR #${prNumber} nÃ£o Ã© manus/* (${headRef}). Ignorando.`);
              return;
            }

            if (pr.state !== "open" || pr.draft) {
              core.info(`PR #${prNumber} nÃ£o estÃ¡ pronto (state=${pr.state}, draft=${pr.draft}).`);
              return;
            }

            // Se Manus jÃ¡ estÃ¡ trabalhando, nÃ£o cria task nova
            const labels = (pr.labels || []).map(l => l.name);
            if (labels.includes(busyLabel)) {
              core.info(`PR #${prNumber} estÃ¡ busy (${busyLabel}). NÃ£o criando task nova agora.`);
              return;
            }

            if (!process.env.MANUS_API_KEY) {
              core.warning("MANUS_API_KEY nÃ£o configurada nos Secrets.");
              return;
            }

            // 2) Agrega feedback do CodeRabbit (comments + review comments + reviews)
            const isCodeRabbitLogin = (login) => {
              const l = String(login || "").toLowerCase();
              return l === "coderabbitai" || l === "coderabbitai[bot]" || l.includes("coderabbit");
            };

            // Issue comments do PR
            const issueComments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            });

            const codeRabbitIssueComments = issueComments
              .filter(c => isCodeRabbitLogin(c.user?.login))
              .map(c => ({
                url: c.html_url,
                body: (c.body || "").trim()
              }));

            // Review thread comments
            const reviewComments = await github.paginate(github.rest.pulls.listReviewComments, {
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100
            });

            const codeRabbitReviewComments = reviewComments
              .filter(c => isCodeRabbitLogin(c.user?.login))
              .map(c => ({
                url: c.html_url,
                body: (c.body || "").trim()
              }));

            // Reviews (submitted)
            const reviews = await github.paginate(github.rest.pulls.listReviews, {
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100
            });

            const codeRabbitReviews = reviews
              .filter(r => isCodeRabbitLogin(r.user?.login))
              .map(r => ({
                url: r.html_url,
                body: (r.body || "").trim()
              }));

            // Junta tudo
            const all = [...codeRabbitIssueComments, ...codeRabbitReviewComments, ...codeRabbitReviews]
              .filter(x => x.body);

            // 3) Filtra actionable
            const actionable = all.filter(x => isActionable(x.body));

            if (actionable.length === 0) {
              core.info("Nenhum feedback actionable do CodeRabbit encontrado apÃ³s 15 minutos. Nada a fazer.");
              return;
            }

            // 4) Marca busy
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels: [busyLabel]
            }).catch(() => {});

            // 5) Monta prompt (com amostra agregada)
            const maxChars = 3500;
            let combined = actionable
              .slice(0, 5) // evita payload enorme
              .map((x, i) => `### Feedback ${i + 1}\nLink: ${x.url}\n\n${x.body}`)
              .join("\n\n---\n\n");

            if (combined.length > maxChars) combined = combined.slice(0, maxChars) + "\n\n...(truncado)";

            const prompt = [
              "VocÃª Ã© o agente Manus e hÃ¡ feedback ACTIONABLE do CodeRabbit neste Pull Request.",
              "",
              `RepositÃ³rio: ${owner}/${repo}`,
              `PR: ${pr.html_url}`,
              `Branch: ${headRef}`,
              "",
              "Resumo do feedback do CodeRabbit (agregado):",
              "```",
              combined,
              "```",
              "",
              "Tarefa:",
              "1) Ler TODO o feedback do CodeRabbit no PR (todas as threads e comentÃ¡rios).",
              "2) Implementar as mudanÃ§as necessÃ¡rias com o MENOR patch possÃ­vel.",
              `3) Fazer push na MESMA branch do PR (${headRef}).`,
              "4) Garantir CI/CodeQL verdes.",
              "5) NÃƒO fazer merge.",
              "",
              "Ao finalizar, comentar no PR:",
              "- o que foi feito",
              "- por que foi feito",
              "- como validar."
            ].join("\n");

            const bodyPayload = {
              prompt,
              agentProfile: "manus-1.6",
              taskMode: "agent",
              interactiveMode: false
            };

            // âœ… CamelCase correto
            if (process.env.MANUS_PROJECT_ID) {
              bodyPayload.projectId = process.env.MANUS_PROJECT_ID;
            }

            // 6) Chama Manus
            const res = await fetch("https://api.manus.ai/v1/tasks", {
              method: "POST",
              headers: {
                "API_KEY": process.env.MANUS_API_KEY,
                "Content-Type": "application/json"
              },
              body: JSON.stringify(bodyPayload)
            });

            if (!res.ok) {
              const text = await res.text();

              // remove busy se falhou
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: prNumber,
                name: busyLabel
              }).catch(() => {});

              throw new Error(`Manus API error: ${res.status} ${text}`);
            }

            const data = await res.json();

            // 7) Comenta no PR
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `ðŸ¤– **Manus Autopilot (debounced 15m)** acionado apÃ³s feedback actionable do CodeRabbit.\nTask: ${data.task_url || "(task_url nÃ£o retornado)"}\n(Label **${busyLabel}** ativa para evitar tasks duplicadas.)`
            }).catch(() => {});
