name: Manus Autopilot (coderabbit)

on:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  autopilot:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Manus when CodeRabbit leaves feedback
        uses: actions/github-script@v7
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_PROJECT_ID: ${{ secrets.MANUS_PROJECT_ID }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const busyLabel = "manus-busy";

            function isCodeRabbitLogin(login) {
              const l = (login || "").toLowerCase();
              return l === "coderabbitai" || l === "coderabbitai[bot]" || l.includes("coderabbit");
            }

            let prNumber = null;
            let feedbackUrl = null;
            let authorLogin = null;
            let feedbackText = "";

            if (context.eventName === "pull_request_review") {
              prNumber = context.payload.pull_request?.number;
              feedbackUrl = context.payload.review?.html_url;
              authorLogin = context.payload.review?.user?.login;
              feedbackText = (context.payload.review?.body || "").trim();
            } else if (context.eventName === "pull_request_review_comment") {
              prNumber = context.payload.pull_request?.number;
              feedbackUrl = context.payload.comment?.html_url;
              authorLogin = context.payload.comment?.user?.login;
              feedbackText = (context.payload.comment?.body || "").trim();
            } else if (context.eventName === "issue_comment") {
              const isPR = !!context.payload.issue?.pull_request;
              if (!isPR) return;
              prNumber = context.payload.issue?.number;
              feedbackUrl = context.payload.comment?.html_url;
              authorLogin = context.payload.comment?.user?.login;
              feedbackText = (context.payload.comment?.body || "").trim();
            } else {
              return;
            }

            if (!prNumber) return;

            if (!isCodeRabbitLogin(authorLogin)) {
              core.info(`Ignorando autor nÃ£o-CodeRabbit: ${authorLogin}`);
              return;
            }

            const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });

            const headRef = pr.data.head.ref || "";
            const state = pr.data.state;
            const draft = pr.data.draft;

            if (!headRef.startsWith("manus/")) {
              core.info(`PR #${prNumber} nÃ£o Ã© manus/* (${headRef}). Ignorando.`);
              return;
            }

            if (state !== "open" || draft) {
              core.info(`PR #${prNumber} nÃ£o estÃ¡ pronto (state=${state}, draft=${draft}). Ignorando.`);
              return;
            }

            const labels = (pr.data.labels || []).map(l => l.name);
            if (labels.includes(busyLabel)) {
              core.info(`PR #${prNumber} jÃ¡ estÃ¡ busy (${busyLabel}).`);
              return;
            }

            await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: [busyLabel] });

            const promptLines = [
              "VocÃª Ã© o agente Manus trabalhando neste repositÃ³rio. HÃ¡ novo feedback do CodeRabbit.",
              "",
              `RepositÃ³rio: ${owner}/${repo}`,
              `PR: ${pr.data.html_url}`,
              `Branch: ${headRef}`,
              `Feedback link: ${feedbackUrl}`,
              `Evento: ${context.eventName}`,
            ];

            if (feedbackText) {
              promptLines.push("", "ConteÃºdo do feedback (texto capturado):", "```", feedbackText, "```");
            }

            promptLines.push(
              "",
              "Tarefa:",
              "1) Ler o feedback completo do CodeRabbit no PR (threads inclusive).",
              "2) Aplicar correÃ§Ãµes/melhorias sugeridas que fizerem sentido.",
              `3) Fazer push na MESMA branch do PR (${headRef}).`,
              "4) Garantir CI/CodeQL verdes (se quebrar, conserte).",
              "5) NÃƒO fazer merge.",
              "",
              "Ao finalizar, comentar no PR:",
              "- o que foi feito",
              "- por que foi feito",
              "- como validar."
            );

            const prompt = promptLines.join("\n");

            async function createManusTask(body) {
              const res = await fetch("https://api.manus.ai/v1/tasks", {
                method: "POST",
                headers: {
                  "API_KEY": process.env.MANUS_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
              });

              const text = await res.text();
              if (!res.ok) {
                const err = new Error(`Manus API error: ${res.status} ${text}`);
                err.status = res.status;
                err.bodyText = text;
                throw err;
              }
              return JSON.parse(text);
            }

            let body = {
              prompt,
              agentProfile: "manus-1.6",
              taskMode: "agent",
              interactiveMode: false
            };

            if (process.env.MANUS_PROJECT_ID) body.projectId = process.env.MANUS_PROJECT_ID;

            let data;
            try {
              data = await createManusTask(body);
            } catch (err) {
              const msg = String(err?.bodyText || err?.message || err);
              const isProjectProblem = (err?.status === 404) && msg.toLowerCase().includes("project");

              if (isProjectProblem) {
                core.warning("MANUS_PROJECT_ID parece invÃ¡lido. Tentando criar task sem projectId...");
                delete body.projectId;
                data = await createManusTask(body);
              } else {
                await github.rest.issues.removeLabel({ owner, repo, issue_number: prNumber, name: busyLabel }).catch(() => {});
                throw err;
              }
            }

            const taskUrl = data.task_url || data.taskUrl || data.url || "(url nÃ£o retornada)";

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `ðŸ¤– Manus Autopilot acionado por feedback do CodeRabbit (**${context.eventName}**).\nTask: ${taskUrl}`
            }).catch(() => {});
