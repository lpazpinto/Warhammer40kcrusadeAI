name: Manus Autopilot (coderabbit)

on:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  autopilot:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Manus when CodeRabbit leaves feedback
        uses: actions/github-script@v7
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_PROJECT_ID: ${{ secrets.MANUS_PROJECT_ID }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const busyLabel = "manus-busy";

            let prNumber = null;
            let feedbackUrl = null;
            let author = null;
            let feedbackText = "";

            // Identifica PR + corpo do comentÃ¡rio/review dependendo do evento
            if (context.eventName === "pull_request_review") {
              prNumber = context.payload.pull_request.number;
              feedbackUrl = context.payload.review.html_url;
              author = context.payload.review.user?.login;
              feedbackText = (context.payload.review.body || "").trim();
            } else if (context.eventName === "pull_request_review_comment") {
              prNumber = context.payload.pull_request.number;
              feedbackUrl = context.payload.comment.html_url;
              author = context.payload.comment.user?.login;
              feedbackText = (context.payload.comment.body || "").trim();
            } else if (context.eventName === "issue_comment") {
              // SÃ³ age se for comentÃ¡rio em PR
              if (!context.payload.issue.pull_request) return;
              prNumber = context.payload.issue.number;
              feedbackUrl = context.payload.comment.html_url;
              author = context.payload.comment.user?.login;
              feedbackText = (context.payload.comment.body || "").trim();
            } else {
              return;
            }

            // Filtro do CodeRabbit
            const login = (author || "").toLowerCase();
            const isCodeRabbit = login === "coderabbitai" || login === "coderabbitai[bot]" || login.includes("coderabbit");

            if (!isCodeRabbit) {
              core.info(`Ignorando autor: ${author}`);
              return;
            }

            // Carrega PR
            const prResp = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            const pr = prResp.data;

            // SÃ³ PRs manus/*
            const headRef = pr.head?.ref || "";
            if (!headRef.startsWith("manus/")) {
              core.info(`Not a manus branch (${headRef}). Exiting.`);
              return;
            }

            // Se PR nÃ£o estÃ¡ pronto, nÃ£o faz nada
            if (pr.state !== "open" || pr.draft) {
              core.info(`PR #${prNumber} nÃ£o estÃ¡ pronto (state=${pr.state}, draft=${pr.draft}).`);
              return;
            }

            // Busy lock
            const labels = (pr.labels || []).map(l => l.name);
            if (labels.includes(busyLabel)) {
              core.info(`PR #${prNumber} jÃ¡ estÃ¡ busy. NÃ£o acionando novamente.`);
              return;
            }

            if (!process.env.MANUS_API_KEY) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `âš ï¸ Manus Autopilot nÃ£o pÃ´de ser acionado porque **MANUS_API_KEY** nÃ£o estÃ¡ configurada nos Secrets.`
              }).catch(() => {});
              return;
            }

            // Marca busy
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels: [busyLabel]
            }).catch(() => {});

            // Monta prompt
            const promptLines = [
              "VocÃª Ã© o agente Manus trabalhando neste repositÃ³rio e hÃ¡ novo feedback do CodeRabbit.",
              "",
              `RepositÃ³rio: ${owner}/${repo}`,
              `PR: ${pr.html_url}`,
              `Branch: ${headRef}`,
              `Evento: ${context.eventName}`,
              `Feedback link: ${feedbackUrl}`
            ];

            if (feedbackText) {
              promptLines.push("", "ConteÃºdo do feedback (texto):", "```", feedbackText, "```");
            }

            promptLines.push(
              "",
              "Tarefa:",
              "1) Ler o feedback completo do CodeRabbit no PR (threads inclusive).",
              "2) Aplicar correÃ§Ãµes/melhorias sugeridas que fizerem sentido.",
              `3) Fazer push na MESMA branch do PR (${headRef}).`,
              "4) Garantir CI/CodeQL verdes (se quebrar, conserte).",
              "5) NÃƒO fazer merge.",
              "",
              "Ao finalizar, comentar no PR:",
              "- o que foi feito",
              "- por que foi feito",
              "- como validar."
            );

            const prompt = promptLines.join("\n");

            // âœ… Payload CORRETO + JSON.stringify correto
            const bodyPayload = {
              prompt,
              agentProfile: "manus-1.6",
              taskMode: "agent",
              interactiveMode: false
            };

            if (process.env.MANUS_PROJECT_ID) {
              bodyPayload.projectId = process.env.MANUS_PROJECT_ID;
            }

            try {
              const res = await fetch("https://api.manus.ai/v1/tasks", {
                method: "POST",
                headers: {
                  "API_KEY": process.env.MANUS_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(bodyPayload)
              });

              if (!res.ok) {
                const text = await res.text();
                // Remove busy se falhou criar task
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: prNumber,
                  name: busyLabel
                }).catch(() => {});
                throw new Error(`Manus API error: ${res.status} ${text}`);
              }

              const data = await res.json();

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `ðŸ¤– **Manus Autopilot acionado por feedback do CodeRabbit** (${context.eventName}).\nTask: ${data.task_url || "(task_url nÃ£o retornado)"}\n(Label **${busyLabel}** ativa para evitar tasks duplicadas.)`
              }).catch(() => {});

              core.info(`Manus task criada para PR #${prNumber} via CodeRabbit.`);
            } catch (err) {
              core.warning(`Erro ao acionar Manus no PR #${prNumber}: ${String(err?.message || err)}`);
              throw err;
            }
